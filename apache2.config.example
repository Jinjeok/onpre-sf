# Apache2 Reverse Proxy Configuration Example (REVISED ORDER)
# IMPORTANT: More specific paths MUST come BEFORE general paths (like /)
# Enable modules: sudo a2enmod proxy proxy_http proxy_wstunnel ssl rewrite headers

<VirtualHost *:80>
    ServerName example.com
    RewriteEngine On
    RewriteCond %{SERVER_NAME} =example.com
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName example.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"

    # --- MUST BE FIRST: WebSocket (For Vite HMR) ---
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:9006/$1 [P,L]

    # --- SECOND: Backend API (Specific Paths) ---
    # Put these above the "/" root proxy
    ProxyPass /feed http://localhost:9004/feed
    ProxyPassReverse /feed http://localhost:9004/feed
    
    # Google OAuth SSO endpoints (/auth/google, /auth/google/callback)
    ProxyPass /auth http://localhost:9004/auth
    ProxyPassReverse /auth http://localhost:9004/auth

    # --- THIRD: Frontend (Catch-all) ---
    ProxyPreserveHost On
    ProxyPass / http://localhost:9006/
    ProxyPassReverse / http://localhost:9006/

    # Handle large file uploads
    LimitRequestBody 0
    ProxyTimeout 300

    ErrorLog ${APACHE_LOG_DIR}/example.com-error.log
    CustomLog ${APACHE_LOG_DIR}/example.com-access.log combined
</VirtualHost>
